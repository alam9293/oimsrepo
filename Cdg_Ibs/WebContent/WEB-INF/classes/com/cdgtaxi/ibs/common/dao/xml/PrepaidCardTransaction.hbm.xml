<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE hibernate-mapping PUBLIC
    "-//Hibernate/Hibernate Mapping DTD 3.0//EN" 
    "http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd">
    
<hibernate-mapping>
<!-- 
    Created by the Middlegen Hibernate plugin 2.1

    http://boss.bekk.no/boss/middlegen/
    http://www.hibernate.org/
-->

<sql-query name="prepaidCardTransaction">
	<return-scalar column="txn_date" 		type="string"/>
	<return-scalar column="action"			type="string"/>
	<return-scalar column="amount"			type="string"/>
	<return-scalar column="card_balance"	type="string"/>
	<return-scalar column="job_no"			type="string"/>
	<return-scalar column="travel_date"		type="string"/>
	<return-scalar column="travel_time"		type="string"/>
	<return-scalar column="taxi_no"			type="string"/>
	<return-scalar column="pickup_address"	type="string"/>
	<return-scalar column="destination"		type="string"/>
	<return-scalar column="fare_amt"		type="string"/>
	<return-scalar column="admin_fee"		type="string"/>
	<return-scalar column="gst"				type="string"/>
	<return-scalar column="total"			type="string"/>
	
	<![CDATA[
  select 
  to_char(txn_date, 'YYYY-MM-DD HH24:MI:SS') as txn_date,
  txn_type as action,
  txn.amount + txn.gst as amount,
  SUM(amount+gst) OVER (PARTITION BY txn.pmtb_product ORDER BY txn_date, txn_no) as card_balance,
  trip.job_no as job_no,
  NVL2(trip.ACQUIRE_TXN_NO, TO_CHAR(trip_start_dt, 'dd/mm/yyyy') || ' TO ' || TO_CHAR(trip_end_dt, 'dd/mm/yyyy') , null) as travel_date,
  NVL2(trip.ACQUIRE_TXN_NO, TO_CHAR(trip_start_dt, 'HH24:MI:SS') || ' TO ' || TO_CHAR(trip_end_dt, 'HH24:MI:SS'), null) as travel_time,
  trip.TAXI_NO as taxi_no,
  trip.PICKUP_ADDRESS as pickup_address,
  trip.DESTINATION as destination,
  trip.fare_amt as fare_amt,
  trip.ADMIN_FEE_VALUE - trip.PROD_DIS_VALUE as admin_fee,
  trip.gst_value as gst,
  trip.fare_amt + trip.ADMIN_FEE_VALUE - trip.PROD_DIS_VALUE + trip.gst_value as total
  from pmtb_prepaid_card_txn txn
  left join pmtb_product product on  txn.PMTB_PRODUCT = product.product_no
  left join tmtb_acquire_txn trip on txn.ACQUIRE_TXN_NO = trip.ACQUIRE_TXN_NO
  where 
  (:cardNo is null or product.card_no = :cardNo)
  order by txn.pmtb_product, txn_date, txn_no
	]]>
</sql-query>
</hibernate-mapping>