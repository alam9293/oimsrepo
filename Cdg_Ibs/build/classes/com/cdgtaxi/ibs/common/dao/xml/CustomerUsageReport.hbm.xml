<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE hibernate-mapping PUBLIC
    "-//Hibernate/Hibernate Mapping DTD 3.0//EN" 
    "http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd">
    
<hibernate-mapping>
<!-- 
    Created by the Middlegen Hibernate plugin 2.1

    http://boss.bekk.no/boss/middlegen/
    http://www.hibernate.org/
-->

<sql-query name="customerUsage">
	<return-scalar column="MONTH" type="string"/>
	<return-scalar column="TRIPS" type="string"/>
	<return-scalar column="AMT" type="string"/>
	<return-scalar column="ADMIN_PERCENT"	type="string"/>
	<return-scalar column="ADMIN_FEE" type="string"/>
	<return-scalar column="GST" type="string"/>
	<return-scalar column="TOTAL" type="string"/>

	<![CDATA[
select to_char(trunc(header.INVOICE_DATE, 'MON'),'MON-yyyy') as MONTH, count(INVOICE_TXN_NO) AS TRIPS, trim(to_char(sum(txn.TXN_AMOUNT),'999,999,990.00')) AS AMT, trim(to_char(sum(txn.ADMIN_FEE)/sum(txn.TXN_AMOUNT)*100,'999,999,990.00')) AS ADMIN_PERCENT, trim(to_char(sum(txn.ADMIN_FEE),'999,999,990.00')) as ADMIN_FEE, trim(to_char(sum(txn.GST),'999,999,990.00')) as GST, trim(to_char(sum(txn.TXN_AMOUNT)+sum(txn.ADMIN_FEE)+sum(txn.GST),'999,999,990.00')) as TOTAL
    from BMTB_INVOICE_TXN txn
    left join BMTB_INVOICE_DETAIL detail using(INVOICE_DETAIL_NO)
    inner join BMTB_INVOICE_SUMMARY summary using(INVOICE_SUMMARY_NO)
    inner join BMTB_INVOICE_HEADER header using(INVOICE_HEADER_NO)
    inner join AMTB_ACCOUNT acct on detail.ACCOUNT_NO = acct.ACCOUNT_NO
    left join AMTB_ACCOUNT parent on acct.PARENT_NO = parent.ACCOUNT_NO
    left join AMTB_ACCOUNT grandparent on parent.PARENT_NO = grandparent.ACCOUNT_NO
    left join PMTB_PRODUCT_TYPE product_type on detail.product_type_id = product_type.product_type_id
    inner join AMTB_ACCOUNT top on (case when grandparent.cust_no is not null then grandparent.account_no when parent.cust_no is not null then parent.account_no else acct.account_no end) = top.account_no
	inner join FMTB_AR_CONT_CODE_MASTER ar on top.ar_control_code_no = ar.ar_control_code_no
	inner join FMTB_ENTITY_MASTER entity on ar.entity_no =entity.entity_no
    where ((:invoiceStartMonth is null and :invoiceEndMonth is null)or(header.INVOICE_DATE between case when :invoiceStartMonth is null then to_date(substr(:invoiceEndMonth,0,8)||'01 00:00:00', 'yyyy-mm-dd hh24:mi:ss') else to_date(substr(:invoiceStartMonth,0,8)||'01 00:00:00', 'yyyy-mm-dd hh24:mi:ss') end and case when :invoiceEndMonth is null then last_day(to_date(substr(:invoiceStartMonth,0,8)||'01 23:59:59', 'yyyy-mm-dd hh24:mi:ss')) else last_day(to_date(:invoiceEndMonth, 'yyyy-mm-dd hh24:mi:ss')) end))
        and (:accountNo is null or top.CUST_NO like :accountNo)
        and (:accountName is null or top.ACCOUNT_NAME like :accountName)
        and TRIP_START_DT is not null
        and (:productType is null or product_type.PRODUCT_TYPE_ID = :productType)
        and (:entityNo is null or entity.ENTITY_NO = :entityNo)
    group by trunc(header.INVOICE_DATE, 'MON')
    order by trunc(header.INVOICE_DATE, 'MON')
	]]>
</sql-query>
</hibernate-mapping>