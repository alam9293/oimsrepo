<?xml version="1.0" encoding="UTF-8"?>
<ds:datasource xmlns:ds="http://www.elixirtech.com/DataSource" name="Customer Aging Summary" type="JDBC" description="">
  <ds:schema case-sensitive="Yes">
    <ds:column name="DUMMY" type="String">
      <ds:attribute name="Nullable" nullable="yes" />
    </ds:column>
    <ds:column name="CUSTOMER_ID" type="String">
      <ds:attribute name="Nullable" nullable="yes" />
    </ds:column>
    <ds:column name="CUSTOMER_NAME" type="String">
      <ds:attribute name="Nullable" nullable="yes" />
    </ds:column>
    <ds:column name="ACCOUNT_CATEGORY" type="String">
      <ds:attribute name="Nullable" nullable="yes" />
    </ds:column>
    <ds:column name="INDUSTRY" type="String">
      <ds:attribute name="Nullable" nullable="yes" />
    </ds:column>
    <ds:column name="SALES_PERSON" type="String">
      <ds:attribute name="Nullable" nullable="yes" />
    </ds:column>
    <ds:column name="OUTSTANDING_AMOUNT" type="Double">
      <ds:attribute name="Nullable" nullable="yes" />
    </ds:column>
    <ds:column name="LESS_0_DAYS" type="Double">
      <ds:attribute name="Nullable" nullable="yes" />
    </ds:column>
    <ds:column name="LESS_30_DAYS" type="Double">
      <ds:attribute name="Nullable" nullable="yes" />
    </ds:column>
    <ds:column name="LESS_60_DAYS" type="Double">
      <ds:attribute name="Nullable" nullable="yes" />
    </ds:column>
    <ds:column name="LESS_90_DAYS" type="Double">
      <ds:attribute name="Nullable" nullable="yes" />
    </ds:column>
    <ds:column name="LESS_120_DAYS" type="Double">
      <ds:attribute name="Nullable" nullable="yes" />
    </ds:column>
    <ds:column name="LESS_150_DAYS" type="Double">
      <ds:attribute name="Nullable" nullable="yes" />
    </ds:column>
    <ds:column name="LESS_180_DAYS" type="Double">
      <ds:attribute name="Nullable" nullable="yes" />
    </ds:column>
    <ds:column name="LESS_210_DAYS" type="Double">
      <ds:attribute name="Nullable" nullable="yes" />
    </ds:column>
    <ds:column name="MORE_210_DAYS" type="Double">
      <ds:attribute name="Nullable" nullable="yes" />
    </ds:column>
    <ds:column name="TURNOVER" type="Double">
      <ds:attribute name="Nullable" nullable="yes" />
    </ds:column>
    <ds:column name="TOTAL_SALES" type="Double">
      <ds:attribute name="Nullable" nullable="yes" />
    </ds:column>
    <ds:column name="DAYS_TO_DATE" type="Double">
      <ds:attribute name="Nullable" nullable="yes" />
    </ds:column>
  </ds:schema>
  <ds:security />
  <ds:jdbc connection-type="POOL" connection-pool="/IBS_Reports/ConnectionPool/IBS Connection Pool.pool" connection-pool-timeout="0" callable-statement="No" connection-reuse="0" nulls-to-strings="No" read-only="Yes" auto-commit="Yes">
    <ds:sql>Select 
	'DUMMY' DUMMY,
	temp2.*,
	
	NVL(
		round(
	 		case
	 			when temp4.divisor is null then 0
	 			when temp4.divisor = 0 then 0
	 			else temp2.OUTSTANDING_AMOUNT / temp4.divisor
	 		end
		)
	, 0) 
	TURNOVER,
	temp5.*
	    
	from(
		Select
		  customer_id, CUSTOMER_NAME, account_category, INDUSTRY, SALES_PERSON,
		  sum(OUTSTANDING_AMOUNT) OUTSTANDING_AMOUNT,
		  sum(LESS_0_DAYS) LESS_0_DAYS,
		  sum(LESS_30_DAYS) LESS_30_DAYS,
		  sum(LESS_60_DAYS) LESS_60_DAYS,
		  sum(LESS_90_DAYS) LESS_90_DAYS,
		  sum(LESS_120_DAYS) LESS_120_DAYS,
		  sum(LESS_150_DAYS) LESS_150_DAYS,
		  sum(LESS_180_DAYS) LESS_180_DAYS,
		  sum(LESS_210_DAYS) LESS_210_DAYS,
		  sum(MORE_210_DAYS) MORE_210_DAYS
		from (
			select
			  case
			    when gp_acct.account_no is not null then gp_acct.cust_no
			    when p_acct.account_no is not null then p_acct.cust_no
			    else acct.cust_no
			  end CUSTOMER_ID,
			  case
			    when gp_acct.account_no is not null then gp_acct.account_name
			    when p_acct.account_no is not null then p_acct.account_name
			    else acct.account_name
			  end CUSTOMER_NAME,
			  case
			    when gp_acct.account_no is not null then gp_acct.account_category
			    when p_acct.account_no is not null then p_acct.account_category
			    else acct.account_category
			  end account_category,
			  bih.invoice_no REF_NO,
			  'INV' REF_TYPE,
			  case 
			    when (trunc(SYSDATE) - NVL(bih.DUE_DATE, trunc(SYSDATE))) &lt;=0 then 0
			    else round(trunc(SYSDATE) - NVL(bih.DUE_DATE, trunc(SYSDATE)))
			  end DAYS_LATE,
			  bih.outstanding_amount OUTSTANDING_AMOUNT,
			  case when (trunc(SYSDATE) - NVL(bih.DUE_DATE, trunc(SYSDATE))) &lt;= 0 then bih.outstanding_amount else 0 end LESS_0_DAYS,
			  case when (trunc(SYSDATE) - NVL(bih.DUE_DATE, trunc(SYSDATE))) &gt;0 AND (trunc(SYSDATE) - NVL(bih.DUE_DATE, trunc(SYSDATE))) &lt;= 30 then bih.outstanding_amount else 0 end LESS_30_DAYS,
			  case when (trunc(SYSDATE) - NVL(bih.DUE_DATE, trunc(SYSDATE))) &gt;30 AND (trunc(SYSDATE) - NVL(bih.DUE_DATE, trunc(SYSDATE))) &lt;= 60 then bih.outstanding_amount else 0 end LESS_60_DAYS,
			  case when (trunc(SYSDATE) - NVL(bih.DUE_DATE, trunc(SYSDATE))) &gt;60 AND (trunc(SYSDATE) - NVL(bih.DUE_DATE, trunc(SYSDATE))) &lt;= 90 then bih.outstanding_amount else 0 end LESS_90_DAYS,
			  case when (trunc(SYSDATE) - NVL(bih.DUE_DATE, trunc(SYSDATE))) &gt;90 AND (trunc(SYSDATE) - NVL(bih.DUE_DATE, trunc(SYSDATE))) &lt;= 120 then bih.outstanding_amount else 0 end LESS_120_DAYS,
			  case when (trunc(SYSDATE) - NVL(bih.DUE_DATE, trunc(SYSDATE))) &gt;120 AND (trunc(SYSDATE) - NVL(bih.DUE_DATE, trunc(SYSDATE))) &lt;= 150 then bih.outstanding_amount else 0 end LESS_150_DAYS,
			  case when (trunc(SYSDATE) - NVL(bih.DUE_DATE, trunc(SYSDATE))) &gt;150 AND (trunc(SYSDATE) - NVL(bih.DUE_DATE, trunc(SYSDATE))) &lt;= 180 then bih.outstanding_amount else 0 end LESS_180_DAYS,
			  case when (trunc(SYSDATE) - NVL(bih.DUE_DATE, trunc(SYSDATE))) &gt;180 AND (trunc(SYSDATE) - NVL(bih.DUE_DATE, trunc(SYSDATE))) &lt;= 210 then bih.outstanding_amount else 0 end LESS_210_DAYS,
			  case when (trunc(SYSDATE) - NVL(bih.DUE_DATE, trunc(SYSDATE))) &gt;210 then bih.outstanding_amount else 0 end MORE_210_DAYS,
			case
			  when sales.name is not null then sales.name
			  when p_sales.name is not null then p_sales.name
			  when gp_sales.name is not null then gp_sales.name
			end SALES_PERSON,
			case
			  when acct_ind.master_no is not null then acct_ind.master_value
			  when p_acct_ind.master_no is not null then p_acct_ind.master_value
			  when gp_acct_ind.master_no is not null then gp_acct_ind.master_value
			  when pers_acct_ind.master_no is not null then pers_acct_ind.master_value
			end INDUSTRY
			from bmtb_invoice_header bih
			inner join amtb_account acct on bih.debt_to = acct.account_no
			left join amtb_account p_acct on acct.parent_no = p_acct.account_no
			left join amtb_account gp_acct on p_acct.parent_no = gp_acct.account_no
			LEFT JOIN (
			    select account_no, max(ACCT_SALESPERSON_NO) as ACCT_SALESPERSON_NO
			    from AMTB_ACCT_SALESPERSON
			    where trunc(sysdate) &gt;= EFFECTIVE_DT_FROM
	            and (trunc(sysdate) &lt;= EFFECTIVE_DT_TO or EFFECTIVE_DT_TO is null)
			    group by account_no
			    ) latest_acct_sales ON latest_acct_sales.account_no = acct.account_no
	        LEFT JOIN AMTB_ACCT_SALESPERSON acct_sales ON acct_sales.ACCT_SALESPERSON_NO = latest_acct_sales.ACCT_SALESPERSON_NO
			LEFT JOIN MSTB_SALESPERSON sales ON acct_sales.salesperson_no = sales.salesperson_no
			LEFT JOIN (
			    select account_no, max(ACCT_SALESPERSON_NO) as ACCT_SALESPERSON_NO
			    from AMTB_ACCT_SALESPERSON
			    where trunc(sysdate) &gt;= EFFECTIVE_DT_FROM
	            and (trunc(sysdate) &lt;= EFFECTIVE_DT_TO or EFFECTIVE_DT_TO is null)
			    group by account_no
			    ) p_latest_acct_sales ON p_latest_acct_sales.account_no = p_acct.account_no
	        LEFT JOIN AMTB_ACCT_SALESPERSON p_acct_sales ON p_acct_sales.ACCT_SALESPERSON_NO = p_latest_acct_sales.ACCT_SALESPERSON_NO
			LEFT JOIN MSTB_SALESPERSON p_sales ON p_acct_sales.salesperson_no = p_sales.salesperson_no
			LEFT JOIN (
			    select account_no, max(ACCT_SALESPERSON_NO) as ACCT_SALESPERSON_NO
			    from AMTB_ACCT_SALESPERSON
			    where trunc(sysdate) &gt;= EFFECTIVE_DT_FROM
	            and (trunc(sysdate) &lt;= EFFECTIVE_DT_TO or EFFECTIVE_DT_TO is null)
			    group by account_no
			    ) gp_latest_acct_sales ON gp_latest_acct_sales.account_no = gp_acct.account_no
	        LEFT JOIN AMTB_ACCT_SALESPERSON gp_acct_sales ON gp_acct_sales.ACCT_SALESPERSON_NO = gp_latest_acct_sales.ACCT_SALESPERSON_NO
			LEFT JOIN MSTB_SALESPERSON gp_sales ON gp_acct_sales.salesperson_no = gp_sales.salesperson_no
			LEFT JOIN AMTB_CORPORATE_DETAIL acct_det ON acct.account_no = acct_det.account_no
			LEFT JOIN AMTB_CORPORATE_DETAIL p_acct_det ON p_acct.account_no = p_acct_det.account_no
			LEFT JOIN AMTB_CORPORATE_DETAIL gp_acct_det ON gp_acct.account_no = gp_acct_det.account_no
			LEFT JOIN AMTB_PERSONAL_DETAIL pers_acct_det ON gp_acct.account_no = pers_acct_det.account_no
			LEFT JOIN MSTB_MASTER_TABLE acct_ind ON acct_det.industry = acct_ind.master_no
			LEFT JOIN MSTB_MASTER_TABLE p_acct_ind ON p_acct_det.industry = p_acct_ind.master_no
			LEFT JOIN MSTB_MASTER_TABLE gp_acct_ind ON gp_acct_det.industry = gp_acct_ind.master_no
			LEFT JOIN MSTB_MASTER_TABLE pers_acct_ind ON pers_acct_det.industry = pers_acct_ind.master_no
			LEFT JOIN FMTB_AR_CONT_CODE_MASTER ar ON ar.AR_CONTROL_CODE_NO = acct.AR_CONTROL_CODE_NO
			LEFT JOIN FMTB_ENTITY_MASTER entity ON ar.entity_no = entity.entity_no
			LEFT JOIN FMTB_AR_CONT_CODE_MASTER p_ar ON p_ar.AR_CONTROL_CODE_NO = p_acct.AR_CONTROL_CODE_NO
			LEFT JOIN FMTB_ENTITY_MASTER p_entity ON p_ar.entity_no = p_entity.entity_no
			LEFT JOIN FMTB_AR_CONT_CODE_MASTER gp_ar ON gp_ar.AR_CONTROL_CODE_NO = gp_acct.AR_CONTROL_CODE_NO
		  	LEFT JOIN FMTB_ENTITY_MASTER gp_entity ON gp_ar.entity_no = gp_entity.entity_no
			WHERE
			  (
			    '${1. Account No}' is null
			    or
			    acct.cust_no = '${1. Account No}'
			    or
			    p_acct.cust_no = '${1. Account No}'
			    or
			    gp_acct.cust_no = '${1. Account No}'
			  )
			  AND
			  (
			    acct.account_name like '${2. Account Name}%'
			    or
			    p_acct.account_name like '${2. Account Name}%'
			    or
			    gp_acct.account_name like '${2. Account Name}%'
			  )
			  AND
			  (
			    '${3. Entity}' is null
			    or
			    entity.entity_no = '${3. Entity}'
			    or
			    p_entity.entity_no = '${3. Entity}'
			    or
			    gp_entity.entity_no = '${3. Entity}'
			  )
			  AND
			  (
			    '${4. AR Control}' is null
			    or
			    ar.AR_CONTROL_CODE_NO = '${4. AR Control}'
			    or
			    p_ar.AR_CONTROL_CODE_NO = '${4. AR Control}'
			    or
			    gp_ar.AR_CONTROL_CODE_NO = '${4. AR Control}'
			  )
			  AND
			  bih.OUTSTANDING_AMOUNT !=0
			  AND
			  (
			    '${5. Outstanding Amount}' is null	  
			    or
			    bih.OUTSTANDING_AMOUNT &gt; '${5. Outstanding Amount}'
			  )
			  AND
			  case when round(trunc(SYSDATE) - NVL(bih.DUE_DATE, trunc(SYSDATE))) &lt;= 0 then 0 else round(trunc(SYSDATE) - NVL(bih.DUE_DATE, trunc(SYSDATE))) end &gt;= '0'
			  AND
			  (
			    '${6. Type}' is null
			    or
			    'I' = '${6. Type}'
			  )	  
		
			UNION ALL
		
			SELECT
			  case
			    when gp_acct.account_no is not null then gp_acct.cust_no
			    when p_acct.account_no is not null then p_acct.cust_no
			    else acct.cust_no
			  end CUSTOMER_ID,
			  case
			    when gp_acct.account_no is not null then gp_acct.account_name
			    when p_acct.account_no is not null then p_acct.account_name
			    else acct.account_name
			  end CUSTOMER_NAME,
			  case
			    when gp_acct.account_no is not null then gp_acct.account_category
			    when p_acct.account_no is not null then p_acct.account_category
			    else acct.account_category
			  end account_category,
			  pr.payment_receipt_no REF_NO,
			  'PR' REF_TYPE,
			  case 
			    when (trunc(SYSDATE) - trunc(pr.receipt_dt)) &lt;=0 then 0
			    else round(trunc(SYSDATE) - trunc(pr.receipt_dt))
			  end DAYS_LATE,
			  NVL(pr.excess_amount,0)*-1 OUTSTANDING_AMOUNT,
			  case when (trunc(SYSDATE) - trunc(pr.receipt_dt)) &lt;= 0 then NVL(pr.excess_amount,0)*-1 else 0 end LESS_0_DAYS,
			  case when (trunc(SYSDATE) - trunc(pr.receipt_dt)) &gt;0 AND (trunc(SYSDATE) - trunc(pr.receipt_dt)) &lt;= 30 then NVL(pr.excess_amount,0)*-1 else 0 end LESS_30_DAYS,
			  case when (trunc(SYSDATE) - trunc(pr.receipt_dt)) &gt;30 AND (trunc(SYSDATE) - trunc(pr.receipt_dt)) &lt;= 60 then NVL(pr.excess_amount,0)*-1 else 0 end LESS_60_DAYS,
			  case when (trunc(SYSDATE) - trunc(pr.receipt_dt)) &gt;60 AND (trunc(SYSDATE) - trunc(pr.receipt_dt)) &lt;= 90 then NVL(pr.excess_amount,0)*-1 else 0 end LESS_90_DAYS,
			  case when (trunc(SYSDATE) - trunc(pr.receipt_dt)) &gt;90 AND (trunc(SYSDATE) - trunc(pr.receipt_dt)) &lt;= 120 then NVL(pr.excess_amount,0)*-1 else 0 end LESS_120_DAYS,
			  case when (trunc(SYSDATE) - trunc(pr.receipt_dt)) &gt;120 AND (trunc(SYSDATE) - trunc(pr.receipt_dt)) &lt;= 150 then NVL(pr.excess_amount,0)*-1 else 0 end LESS_150_DAYS,
			  case when (trunc(SYSDATE) - trunc(pr.receipt_dt)) &gt;150 AND (trunc(SYSDATE) - trunc(pr.receipt_dt)) &lt;= 180 then NVL(pr.excess_amount,0)*-1 else 0 end LESS_180_DAYS,
			  case when (trunc(SYSDATE) - trunc(pr.receipt_dt)) &gt;180 AND (trunc(SYSDATE) - trunc(pr.receipt_dt)) &lt;= 210 then NVL(pr.excess_amount,0)*-1 else 0 end LESS_210_DAYS,
			  case when (trunc(SYSDATE) - trunc(pr.receipt_dt)) &gt;210 then NVL(pr.excess_amount,0)*-1 else 0 end MORE_210_DAYS,
			case
			  when sales.name is not null then sales.name
			  when p_sales.name is not null then p_sales.name
			  when gp_sales.name is not null then gp_sales.name
			end SALES_PERSON,
			case
			  when acct_ind.master_no is not null then acct_ind.master_value
			  when p_acct_ind.master_no is not null then p_acct_ind.master_value
			  when gp_acct_ind.master_no is not null then gp_acct_ind.master_value
			  when pers_acct_ind.master_no is not null then pers_acct_ind.master_value
			end INDUSTRY
			FROM bmtb_payment_receipt pr
			inner join amtb_account acct on pr.account_no = acct.account_no
			left join amtb_account p_acct on acct.parent_no = p_acct.account_no
			left join amtb_account gp_acct on p_acct.parent_no = gp_acct.account_no
			LEFT JOIN (
			    select account_no, max(ACCT_SALESPERSON_NO) as ACCT_SALESPERSON_NO
			    from AMTB_ACCT_SALESPERSON
			    where trunc(sysdate) &gt;= EFFECTIVE_DT_FROM
	            and (trunc(sysdate) &lt;= EFFECTIVE_DT_TO or EFFECTIVE_DT_TO is null)
			    group by account_no
			    ) latest_acct_sales ON latest_acct_sales.account_no = acct.account_no
	        LEFT JOIN AMTB_ACCT_SALESPERSON acct_sales ON acct_sales.ACCT_SALESPERSON_NO = latest_acct_sales.ACCT_SALESPERSON_NO
			LEFT JOIN MSTB_SALESPERSON sales ON acct_sales.salesperson_no = sales.salesperson_no
			LEFT JOIN (
			    select account_no, max(ACCT_SALESPERSON_NO) as ACCT_SALESPERSON_NO
			    from AMTB_ACCT_SALESPERSON
			    where trunc(sysdate) &gt;= EFFECTIVE_DT_FROM
	            and (trunc(sysdate) &lt;= EFFECTIVE_DT_TO or EFFECTIVE_DT_TO is null)
			    group by account_no
			    ) p_latest_acct_sales ON p_latest_acct_sales.account_no = p_acct.account_no
	        LEFT JOIN AMTB_ACCT_SALESPERSON p_acct_sales ON p_acct_sales.ACCT_SALESPERSON_NO = p_latest_acct_sales.ACCT_SALESPERSON_NO
			LEFT JOIN MSTB_SALESPERSON p_sales ON p_acct_sales.salesperson_no = p_sales.salesperson_no
			LEFT JOIN (
			    select account_no, max(ACCT_SALESPERSON_NO) as ACCT_SALESPERSON_NO
			    from AMTB_ACCT_SALESPERSON
			    where trunc(sysdate) &gt;= EFFECTIVE_DT_FROM
	            and (trunc(sysdate) &lt;= EFFECTIVE_DT_TO or EFFECTIVE_DT_TO is null)
			    group by account_no
			    ) gp_latest_acct_sales ON gp_latest_acct_sales.account_no = gp_acct.account_no
	        LEFT JOIN AMTB_ACCT_SALESPERSON gp_acct_sales ON gp_acct_sales.ACCT_SALESPERSON_NO = gp_latest_acct_sales.ACCT_SALESPERSON_NO
			LEFT JOIN MSTB_SALESPERSON gp_sales ON gp_acct_sales.salesperson_no = gp_sales.salesperson_no
			LEFT JOIN AMTB_CORPORATE_DETAIL acct_det ON acct.account_no = acct_det.account_no
			LEFT JOIN AMTB_CORPORATE_DETAIL p_acct_det ON p_acct.account_no = p_acct_det.account_no
			LEFT JOIN AMTB_CORPORATE_DETAIL gp_acct_det ON gp_acct.account_no = gp_acct_det.account_no
			LEFT JOIN AMTB_PERSONAL_DETAIL pers_acct_det ON gp_acct.account_no = pers_acct_det.account_no
			LEFT JOIN MSTB_MASTER_TABLE acct_ind ON acct_det.industry = acct_ind.master_no
			LEFT JOIN MSTB_MASTER_TABLE p_acct_ind ON p_acct_det.industry = p_acct_ind.master_no
			LEFT JOIN MSTB_MASTER_TABLE gp_acct_ind ON gp_acct_det.industry = gp_acct_ind.master_no
			LEFT JOIN MSTB_MASTER_TABLE pers_acct_ind ON pers_acct_det.industry = pers_acct_ind.master_no
			LEFT JOIN FMTB_AR_CONT_CODE_MASTER ar ON ar.AR_CONTROL_CODE_NO = acct.AR_CONTROL_CODE_NO
			LEFT JOIN FMTB_ENTITY_MASTER entity ON ar.entity_no = entity.entity_no
			LEFT JOIN FMTB_AR_CONT_CODE_MASTER p_ar ON p_ar.AR_CONTROL_CODE_NO = p_acct.AR_CONTROL_CODE_NO
			LEFT JOIN FMTB_ENTITY_MASTER p_entity ON p_ar.entity_no = p_entity.entity_no
			LEFT JOIN FMTB_AR_CONT_CODE_MASTER gp_ar ON gp_ar.AR_CONTROL_CODE_NO = gp_acct.AR_CONTROL_CODE_NO
		  	LEFT JOIN FMTB_ENTITY_MASTER gp_entity ON gp_ar.entity_no = gp_entity.entity_no
			WHERE 
			  (
			    '${1. Account No}' is null
			    or
			    acct.cust_no = '${1. Account No}'
			    or
			    p_acct.cust_no = '${1. Account No}'
			    or
			    gp_acct.cust_no = '${1. Account No}'
			  )
			  AND
			  (
			    acct.account_name like '${2. Account Name}%'
			    or
			    p_acct.account_name like '${2. Account Name}%'
			    or
			    gp_acct.account_name like '${2. Account Name}%'
			  )
			  AND
			  (
			    '${3. Entity}' is null
			    or
			    entity.entity_no = '${3. Entity}'
			    or
			    p_entity.entity_no = '${3. Entity}'
			    or
			    gp_entity.entity_no = '${3. Entity}'
			  )
			  AND
			  (
			    '${4. AR Control}' is null
			    or
			    ar.AR_CONTROL_CODE_NO = '${4. AR Control}'
			    or
			    p_ar.AR_CONTROL_CODE_NO = '${4. AR Control}'
			    or
			    gp_ar.AR_CONTROL_CODE_NO = '${4. AR Control}'
			  )
			  AND
			  (
			    '${5. Outstanding Amount}' is null
			    or
			    (pr.EXCESS_AMOUNT*-1) &gt; '${5. Outstanding Amount}'
			  )
			  AND
			  pr.EXCESS_AMOUNT &gt; 0
			  AND
	          pr.CANCEL_DT is null
			  AND
			  case when round(trunc(SYSDATE) - trunc(pr.receipt_dt)) &lt;= 0 then 0 else round(trunc(SYSDATE) - trunc(pr.receipt_dt)) end &gt;= '0'
			  AND
			  (
			    '${6. Type}' is null
			    or
			    'R' = '${6. Type}'
			  )	  
		
			UNION ALL
		
			SELECT
			  case
			    when gp_acct.account_no is not null then gp_acct.cust_no
			    when p_acct.account_no is not null then p_acct.cust_no
			    else acct.cust_no
			  end CUSTOMER_ID,
			  case
			    when gp_acct.account_no is not null then gp_acct.account_name
			    when p_acct.account_no is not null then p_acct.account_name
			    else acct.account_name
			  end CUSTOMER_NAME,
			  case
			    when gp_acct.account_no is not null then gp_acct.account_category
			    when p_acct.account_no is not null then p_acct.account_category
			    else acct.account_category
			  end account_category,
			  note.note_no REF_NO,
			  note.note_type REF_TYPE,
			  0 DAYS_LATE,
			  case 
			    when note.note_type = 'C' then (note.NOTE_AMOUNT + note.ADMIN_FEE - note.DISCOUNT - note.PROD_DIS + note.GST) * -1
			    when note.note_type = 'D' then (note.NOTE_AMOUNT + note.ADMIN_FEE - note.DISCOUNT - note.PROD_DIS + note.GST)
			    else 0
			  end OUTSTANDING_AMOUNT,
			  case when (trunc(SYSDATE) - trunc(note.created_dt)) &lt;= 0 then 
		              case 
			      when note.note_type = 'C' then (note.NOTE_AMOUNT + note.ADMIN_FEE - note.DISCOUNT - note.PROD_DIS + note.GST) * -1
		                when note.note_type = 'D' then (note.NOTE_AMOUNT + note.ADMIN_FEE - note.DISCOUNT - note.PROD_DIS + note.GST)
		                else 0
			    end
			  else 0 end LESS_0_DAYS,
			  case when (trunc(SYSDATE) - trunc(note.created_dt)) &gt;0 AND (trunc(SYSDATE) - trunc(note.created_dt)) &lt;= 30 then 
		              case 
			      when note.note_type = 'C' then (note.NOTE_AMOUNT + note.ADMIN_FEE - note.DISCOUNT - note.PROD_DIS + note.GST) * -1
		                when note.note_type = 'D' then (note.NOTE_AMOUNT + note.ADMIN_FEE - note.DISCOUNT - note.PROD_DIS + note.GST)
		                else 0
			    end
			  else 0 end LESS_30_DAYS,
			  case when (trunc(SYSDATE) - trunc(note.created_dt)) &gt;30 AND (trunc(SYSDATE) - trunc(note.created_dt)) &lt;= 60 then 
		              case 
			      when note.note_type = 'C' then (note.NOTE_AMOUNT + note.ADMIN_FEE - note.DISCOUNT - note.PROD_DIS + note.GST) * -1
		                when note.note_type = 'D' then (note.NOTE_AMOUNT + note.ADMIN_FEE - note.DISCOUNT - note.PROD_DIS + note.GST)
		                else 0
			    end  
			  else 0 end LESS_60_DAYS,
			  case when (trunc(SYSDATE) - trunc(note.created_dt)) &gt;60 AND (trunc(SYSDATE) - trunc(note.created_dt)) &lt;= 90 then 
			    case 
			      when note.note_type = 'C' then (note.NOTE_AMOUNT + note.ADMIN_FEE - note.DISCOUNT - note.PROD_DIS + note.GST) * -1
				  when note.note_type = 'D' then (note.NOTE_AMOUNT + note.ADMIN_FEE - note.DISCOUNT - note.PROD_DIS + note.GST)
				  else 0
				end
			  else 0 end LESS_90_DAYS,
			  case when (trunc(SYSDATE) - trunc(note.created_dt)) &gt;90 AND (trunc(SYSDATE) - trunc(note.created_dt)) &lt;= 120 then 
			    case 
			      when note.note_type = 'C' then (note.NOTE_AMOUNT + note.ADMIN_FEE - note.DISCOUNT - note.PROD_DIS + note.GST) * -1
				  when note.note_type = 'D' then (note.NOTE_AMOUNT + note.ADMIN_FEE - note.DISCOUNT - note.PROD_DIS + note.GST)
				  else 0
				end
			  else 0 end LESS_120_DAYS,
			  case when (trunc(SYSDATE) - trunc(note.created_dt)) &gt;120 AND (trunc(SYSDATE) - trunc(note.created_dt)) &lt;= 150 then 
		              case 
			      when note.note_type = 'C' then (note.NOTE_AMOUNT + note.ADMIN_FEE - note.DISCOUNT - note.PROD_DIS + note.GST) * -1
		                when note.note_type = 'D' then (note.NOTE_AMOUNT + note.ADMIN_FEE - note.DISCOUNT - note.PROD_DIS + note.GST)
		                else 0
			    end
			  else 0 end LESS_150_DAYS,
			  case when (trunc(SYSDATE) - trunc(note.created_dt)) &gt;150 AND (trunc(SYSDATE) - trunc(note.created_dt)) &lt;= 180 then 
		              case 
			      when note.note_type = 'C' then (note.NOTE_AMOUNT + note.ADMIN_FEE - note.DISCOUNT - note.PROD_DIS + note.GST) * -1
		                when note.note_type = 'D' then (note.NOTE_AMOUNT + note.ADMIN_FEE - note.DISCOUNT - note.PROD_DIS + note.GST)
		                else 0
			    end
			  else 0 end LESS_180_DAYS,
			  case when (trunc(SYSDATE) - trunc(note.created_dt)) &gt;180 AND (trunc(SYSDATE) - trunc(note.created_dt)) &lt;= 210 then 
		              case 
			      when note.note_type = 'C' then (note.NOTE_AMOUNT + note.ADMIN_FEE - note.DISCOUNT - note.PROD_DIS + note.GST) * -1
		                when note.note_type = 'D' then (note.NOTE_AMOUNT + note.ADMIN_FEE - note.DISCOUNT - note.PROD_DIS + note.GST)
		                else 0
			    end
			  else 0 end LESS_210_DAYS,
			  case when (trunc(SYSDATE) - trunc(note.created_dt)) &gt;210 then 
		              case 
			      when note.note_type = 'C' then (note.NOTE_AMOUNT + note.ADMIN_FEE - note.DISCOUNT - note.PROD_DIS + note.GST) * -1
		                when note.note_type = 'D' then (note.NOTE_AMOUNT + note.ADMIN_FEE - note.DISCOUNT - note.PROD_DIS + note.GST)
		                else 0
			    end
			  else 0 end MORE_210_DAYS,
			case
			  when sales.name is not null then sales.name
			  when p_sales.name is not null then p_sales.name
			  when gp_sales.name is not null then gp_sales.name
			end SALES_PERSON,
			case
			  when acct_ind.master_no is not null then acct_ind.master_value
			  when p_acct_ind.master_no is not null then p_acct_ind.master_value
			  when gp_acct_ind.master_no is not null then gp_acct_ind.master_value
			  when pers_acct_ind.master_no is not null then pers_acct_ind.master_value
			end INDUSTRY
			FROM bmtb_note note
			inner join amtb_account acct on note.account_no = acct.account_no
			left join amtb_account p_acct on acct.parent_no = p_acct.account_no
			left join amtb_account gp_acct on p_acct.parent_no = gp_acct.account_no
			LEFT JOIN (
			    select account_no, max(ACCT_SALESPERSON_NO) as ACCT_SALESPERSON_NO
			    from AMTB_ACCT_SALESPERSON
			    where trunc(sysdate) &gt;= EFFECTIVE_DT_FROM
	            and (trunc(sysdate) &lt;= EFFECTIVE_DT_TO or EFFECTIVE_DT_TO is null)
			    group by account_no
			    ) latest_acct_sales ON latest_acct_sales.account_no = acct.account_no
	        LEFT JOIN AMTB_ACCT_SALESPERSON acct_sales ON acct_sales.ACCT_SALESPERSON_NO = latest_acct_sales.ACCT_SALESPERSON_NO
			LEFT JOIN MSTB_SALESPERSON sales ON acct_sales.salesperson_no = sales.salesperson_no
			LEFT JOIN (
			    select account_no, max(ACCT_SALESPERSON_NO) as ACCT_SALESPERSON_NO
			    from AMTB_ACCT_SALESPERSON
			    where trunc(sysdate) &gt;= EFFECTIVE_DT_FROM
	            and (trunc(sysdate) &lt;= EFFECTIVE_DT_TO or EFFECTIVE_DT_TO is null)
			    group by account_no
			    ) p_latest_acct_sales ON p_latest_acct_sales.account_no = p_acct.account_no
	        LEFT JOIN AMTB_ACCT_SALESPERSON p_acct_sales ON p_acct_sales.ACCT_SALESPERSON_NO = p_latest_acct_sales.ACCT_SALESPERSON_NO
			LEFT JOIN MSTB_SALESPERSON p_sales ON p_acct_sales.salesperson_no = p_sales.salesperson_no
			LEFT JOIN (
			    select account_no, max(ACCT_SALESPERSON_NO) as ACCT_SALESPERSON_NO
			    from AMTB_ACCT_SALESPERSON
			    where trunc(sysdate) &gt;= EFFECTIVE_DT_FROM
	            and (trunc(sysdate) &lt;= EFFECTIVE_DT_TO or EFFECTIVE_DT_TO is null)
			    group by account_no
			    ) gp_latest_acct_sales ON gp_latest_acct_sales.account_no = gp_acct.account_no
	        LEFT JOIN AMTB_ACCT_SALESPERSON gp_acct_sales ON gp_acct_sales.ACCT_SALESPERSON_NO = gp_latest_acct_sales.ACCT_SALESPERSON_NO
			LEFT JOIN MSTB_SALESPERSON gp_sales ON gp_acct_sales.salesperson_no = gp_sales.salesperson_no
			LEFT JOIN AMTB_CORPORATE_DETAIL acct_det ON acct.account_no = acct_det.account_no
			LEFT JOIN AMTB_CORPORATE_DETAIL p_acct_det ON p_acct.account_no = p_acct_det.account_no
			LEFT JOIN AMTB_CORPORATE_DETAIL gp_acct_det ON gp_acct.account_no = gp_acct_det.account_no
			LEFT JOIN AMTB_PERSONAL_DETAIL pers_acct_det ON gp_acct.account_no = pers_acct_det.account_no
			LEFT JOIN MSTB_MASTER_TABLE acct_ind ON acct_det.industry = acct_ind.master_no
			LEFT JOIN MSTB_MASTER_TABLE p_acct_ind ON p_acct_det.industry = p_acct_ind.master_no
			LEFT JOIN MSTB_MASTER_TABLE gp_acct_ind ON gp_acct_det.industry = gp_acct_ind.master_no
			LEFT JOIN MSTB_MASTER_TABLE pers_acct_ind ON pers_acct_det.industry = pers_acct_ind.master_no
			LEFT JOIN FMTB_AR_CONT_CODE_MASTER ar ON ar.AR_CONTROL_CODE_NO = acct.AR_CONTROL_CODE_NO
			LEFT JOIN FMTB_ENTITY_MASTER entity ON ar.entity_no = entity.entity_no
			LEFT JOIN FMTB_AR_CONT_CODE_MASTER p_ar ON p_ar.AR_CONTROL_CODE_NO = p_acct.AR_CONTROL_CODE_NO
			LEFT JOIN FMTB_ENTITY_MASTER p_entity ON p_ar.entity_no = p_entity.entity_no
			LEFT JOIN FMTB_AR_CONT_CODE_MASTER gp_ar ON gp_ar.AR_CONTROL_CODE_NO = gp_acct.AR_CONTROL_CODE_NO
		  	LEFT JOIN FMTB_ENTITY_MASTER gp_entity ON gp_ar.entity_no = gp_entity.entity_no
			WHERE 
			  (
			    '${1. Account No}' is null
			    or
			    acct.cust_no = '${1. Account No}'
			    or
			    p_acct.cust_no = '${1. Account No}'
			    or
			    gp_acct.cust_no = '${1. Account No}'
			  )
			  AND
			  (
			    acct.account_name like '${2. Account Name}%'
			    or
			    p_acct.account_name like '${2. Account Name}%'
			    or
			    gp_acct.account_name like '${2. Account Name}%'
			  )
			  AND
			  (
			    '${3. Entity}' is null
			    or
			    entity.entity_no = '${3. Entity}'
			    or
			    p_entity.entity_no = '${3. Entity}'
			    or
			    gp_entity.entity_no = '${3. Entity}'
			  )
			  AND
			  (
			    '${4. AR Control}' is null
			    or
			    ar.AR_CONTROL_CODE_NO = '${4. AR Control}'
			    or
			    p_ar.AR_CONTROL_CODE_NO = '${4. AR Control}'
			    or
			    gp_ar.AR_CONTROL_CODE_NO = '${4. AR Control}'
			  )
			  AND
			  (
			    '${5. Outstanding Amount}' is null
			    or
			    note.NOTE_AMOUNT &gt; '${5. Outstanding Amount}'
			  )
			  AND
			  note.status = 'A'
			  AND
			  case when round(trunc(SYSDATE) - trunc(note.created_dt)) &lt;= 0 then 0 else round(trunc(SYSDATE) - trunc(note.created_dt)) end &gt;= 0
			  AND
			  (
			    '${6. Type}' is null
			    or
			    note.note_type = '${6. Type}'
			  )
		) temp
		group by customer_id, CUSTOMER_NAME, account_category, INDUSTRY, SALES_PERSON
		order by
		case when '${7. Sort By}' = '1' then CUSTOMER_NAME END,
		case when '${7. Sort By}' = '1' then customer_id END,
		case when '${7. Sort By}' = '2' then OUTSTANDING_AMOUNT END asc,
		case when '${7. Sort By}' = '2' then CUSTOMER_NAME END,
		case when '${7. Sort By}' = '2' then customer_id END,
		case when '${7. Sort By}' = '3' then OUTSTANDING_AMOUNT END desc,
		case when '${7. Sort By}' = '3' then CUSTOMER_NAME END,
		case when '${7. Sort By}' = '3' then customer_id END
	) temp2
	left join (
		select
			customer_id,
            (
                sum(total_sales)
                /
                -- Divide by days to date to the current year
                -- +1 to include current day therefore will never encounter 0 [(01-01-2010 - 01-01-2010 + 1) = 1]
                ((trunc(sysdate) - to_date(to_char(sysdate, 'yyyy')||'-01-01', 'yyyy-mm-dd')) + 1)
            ) as divisor
		from (	
	        select
               	case 
                   when gp_acct.CUST_NO is not null then gp_acct.CUST_NO
                   when p_acct.CUST_NO is not null then p_acct.CUST_NO
                   when acct.CUST_NO is not null then acct.CUST_NO
            	end as customer_id,
				sum(new_txn) as total_sales
            from bmtb_invoice_header bih
			inner join amtb_account acct on acct.account_no = bih.debt_to
			left join amtb_account p_acct on p_acct.account_no = acct.parent_no
			left join amtb_account gp_acct on gp_acct.account_no = p_acct.parent_no
			where
		  	to_char(bih.INVOICE_DATE, 'yyyy') = to_char(sysdate, 'yyyy')
		  	AND
		  	bih.new_txn != 0
            group by acct.CUST_NO, p_acct.CUST_NO, gp_acct.CUST_NO
       	) temp3
        group by customer_id
	) temp4 on temp2.customer_id = temp4.customer_id

left join (
	select
		customer_id, sum(total_sales), max(days_to_date)
	from(
		select
           	    	case 
                   		when gp_acct.CUST_NO is not null then gp_acct.CUST_NO
                   		when p_acct.CUST_NO is not null then p_acct.CUST_NO
                   		when acct.CUST_NO is not null then acct.CUST_NO
	            	end as customer_id,
			sum(new_txn) as total_sales,
			-- +1 to include current day therefore will never encounter 0 [(01-01-2010 - 01-01-2010 + 1) = 1]
                		((trunc(sysdate) - to_date(to_char(sysdate, 'yyyy')||'-01-01', 'yyyy-mm-dd')) + 1) as days_to_date
            		from bmtb_invoice_header bih
				inner join amtb_account acct on acct.account_no = bih.debt_to
				left join amtb_account p_acct on p_acct.account_no = acct.parent_no
				left join amtb_account gp_acct on gp_acct.account_no = p_acct.parent_no
			where
			  	to_char(bih.INVOICE_DATE, 'yyyy') = to_char(sysdate, 'yyyy')
			  	AND
			  	bih.new_txn != 0
           		 group by acct.CUST_NO, p_acct.CUST_NO, gp_acct.CUST_NO
	) group by customer_id
) temp5 on temp2.customer_id = temp5.customer_id</ds:sql>
  </ds:jdbc>
</ds:datasource>

