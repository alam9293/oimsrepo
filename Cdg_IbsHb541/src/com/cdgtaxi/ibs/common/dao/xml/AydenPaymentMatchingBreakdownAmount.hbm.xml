<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE hibernate-mapping PUBLIC
        "-//Hibernate/Hibernate Mapping DTD 3.0//EN"
        "http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd">

<hibernate-mapping>
    <!--
        Created by the Middlegen Hibernate plugin 2.1

        http://boss.bekk.no/boss/middlegen/
        http://www.hibernate.org/
    -->

    <sql-query name="AydenPaymentMatchingBreakdownAmount">
        <return alias="crca" class="com.cdgtaxi.ibs.common.model.TmtbNonBillableTxnCrca"/>
        <![CDATA[

SELECT {crca.*} FROM TMTB_NON_BILLABLE_TXN_CRCA crca where record_type in (:recordType) and file_name in (
    SELECT crca.file_name from TMTB_NON_BILLABLE_TXN txn, TMTB_NON_BILLABLE_BATCH batch,TMTB_NON_BILLABLE_TXN_CRCA crca where (batch.settlement_date between :settlementStartDate and :settlementEndDate) and batch.batch_id = txn.batch_id and (:batchNo is null or batch.batch_no = :batchNo) and txn.pspreference1 = crca.psp_ref_no and txn.PSPREFERENCE1 is not null
    UNION
    SELECT crca.file_name from TMTB_NON_BILLABLE_TXN txn, TMTB_NON_BILLABLE_BATCH batch,TMTB_NON_BILLABLE_TXN_CRCA crca where (batch.settlement_date between :settlementStartDate and :settlementEndDate) and batch.batch_id = txn.batch_id and (:batchNo is null or batch.batch_no = :batchNo) and txn.pspreference2 = crca.psp_ref_no and txn.PSPREFERENCE2 is not null
) and psp_ref_no not in
(
    SELECT crca.psp_ref_no from TMTB_NON_BILLABLE_TXN txn, TMTB_NON_BILLABLE_BATCH batch,TMTB_NON_BILLABLE_TXN_CRCA crca where (batch.settlement_date between :settlementStartDate and :settlementEndDate) and batch.batch_id = txn.batch_id and (:batchNo is null or batch.batch_no = :batchNo) and txn.pspreference1 = crca.psp_ref_no and txn.PSPREFERENCE1 is not null
    UNION
    SELECT crca.psp_ref_no from TMTB_NON_BILLABLE_TXN txn,  TMTB_NON_BILLABLE_BATCH batch,TMTB_NON_BILLABLE_TXN_CRCA crca where (batch.settlement_date between :settlementStartDate and :settlementEndDate) and batch.batch_id = txn.batch_id and (:batchNo is null or batch.batch_no = :batchNo) and txn.pspreference2 = crca.psp_ref_no and txn.PSPREFERENCE2 is not null
) order by file_name

	]]>
    </sql-query>
</hibernate-mapping>