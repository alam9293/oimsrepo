<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE hibernate-mapping PUBLIC
    "-//Hibernate/Hibernate Mapping DTD 3.0//EN" 
    "http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd">
    
<hibernate-mapping>
<!-- 
    Created by the Middlegen Hibernate plugin 2.1

    http://boss.bekk.no/boss/middlegen/
    http://www.hibernate.org/
-->

<sql-query name="customerUsageCardLevel">
	<return-scalar column="CARDNO" type="string"/>
	<return-scalar column="CARDHOLDERNAME" type="string"/>
	<return-scalar column="DIVNAME" type="string"/>
	<return-scalar column="DIVCODE" type="string"/>
	<return-scalar column="DEPTNAME" type="string"/>
	<return-scalar column="DEPTCODE" type="string"/>	
	<return-scalar column="MONTH" type="string"/>
	<return-scalar column="TRIPS" type="string"/>
	<return-scalar column="AMT" type="string"/>
	<return-scalar column="ADMIN_PERCENT"	type="string"/>
	<return-scalar column="ADMIN_FEE" type="string"/>
	<return-scalar column="GST" type="string"/>
	<return-scalar column="TOTAL" type="string"/>

	<![CDATA[
	select  concat('''',txn.Card_no) AS CARDNO, product.card_holder_name AS CARDHOLDERNAME,
	CASE WHEN acct.account_category='DEPT' Then parent.Account_name 
		WHEN acct.account_category='DIV' Then acct.Account_name ELSE null End AS DIVNAME ,
	CASE WHEN acct.account_category='DEPT' Then parent.CODE 
		WHEN acct.account_category='DIV' Then acct.CODE ELSE null End AS DIVCODE ,
	CASE WHEN acct.account_category='DEPT' Then acct.Account_name ELSE null End AS DEPTNAME ,
	CASE WHEN acct.account_category='DEPT' Then acct.CODE ELSE null End AS DEPTCODE ,
	to_char(trunc(header.INVOICE_DATE, 'MON'),'MON-yyyy') as MONTH, count(INVOICE_TXN_NO) AS TRIPS, trim(to_char(sum(txn.TXN_AMOUNT),'999,999,990.00')) AS AMT, CASE WHEN sum(txn.TXN_AMOUNT)>0 THEN trim(to_char(sum(txn.ADMIN_FEE)/sum(txn.TXN_AMOUNT)*100,'999,999,990.00')) ELSE '0' END AS ADMIN_PERCENT, trim(to_char(sum(txn.ADMIN_FEE),'999,999,990.00')) as ADMIN_FEE, trim(to_char(sum(txn.GST),'999,999,990.00')) as GST, trim(to_char(sum(txn.TXN_AMOUNT)+sum(txn.ADMIN_FEE)+sum(txn.GST),'999,999,990.00')) as TOTAL
    from BMTB_INVOICE_TXN txn
    left join BMTB_INVOICE_DETAIL detail using(INVOICE_DETAIL_NO)
    inner join BMTB_INVOICE_SUMMARY summary using(INVOICE_SUMMARY_NO)
    inner join BMTB_INVOICE_HEADER header using(INVOICE_HEADER_NO)
    inner join AMTB_ACCOUNT acct on detail.ACCOUNT_NO = acct.ACCOUNT_NO
    left join AMTB_ACCOUNT parent on acct.PARENT_NO = parent.ACCOUNT_NO
    left join AMTB_ACCOUNT grandparent on parent.PARENT_NO = grandparent.ACCOUNT_NO
    left join PMTB_PRODUCT_TYPE product_type on detail.product_type_id = product_type.product_type_id
    inner join AMTB_ACCOUNT top on (case when grandparent.cust_no is not null then grandparent.account_no when parent.cust_no is not null then parent.account_no else acct.account_no end) = top.account_no
	inner join FMTB_AR_CONT_CODE_MASTER ar on top.ar_control_code_no = ar.ar_control_code_no
	inner join FMTB_ENTITY_MASTER entity on ar.entity_no =entity.entity_no
	inner join PMTB_PRODUCT product on txn.CARD_NO = product.CARD_NO
    where ((:invoiceStartMonth is null and :invoiceEndMonth is null)or(header.INVOICE_DATE between case when :invoiceStartMonth is null then to_date(substr(:invoiceEndMonth,0,8)||'01 00:00:00', 'yyyy-mm-dd hh24:mi:ss') else to_date(substr(:invoiceStartMonth,0,8)||'01 00:00:00', 'yyyy-mm-dd hh24:mi:ss') end and case when :invoiceEndMonth is null then last_day(to_date(substr(:invoiceStartMonth,0,8)||'01 23:59:59', 'yyyy-mm-dd hh24:mi:ss')) else last_day(to_date(:invoiceEndMonth, 'yyyy-mm-dd hh24:mi:ss')) end))
        and (:cardNo is null or txn.CARD_NO = :cardNo)
        and (:accountNo is null or top.CUST_NO like :accountNo)
        and (:accountName is null or top.ACCOUNT_NAME like :accountName)
        and TRIP_START_DT is not null
        and (:productType is null or product_type.PRODUCT_TYPE_ID = :productType)
        and (:entityNo is null or entity.ENTITY_NO = :entityNo)
        and (:expiryDT is null or product.EXPIRY_DATE between to_date(substr(:expiryDT,0,8)||'01 00:00:00', 'yyyy-mm-dd hh24:mi:ss') and last_day(to_date(:expiryDT, 'yyyy-mm-dd hh24:mi:ss')))
    group by txn.Card_no,product.card_holder_name,header.INVOICE_DATE,acct.account_category,acct.Account_name,parent.account_category,parent.Account_name,parent.code,acct.code
    order by txn.Card_no,header.INVOICE_DATE
	]]>
</sql-query>
</hibernate-mapping>